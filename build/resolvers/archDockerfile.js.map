{"version":3,"sources":["../src/resolvers/archDockerfile.ts"],"names":[],"mappings":";;AAAA,oCAAoC;AAEpC,6BAA6B;AAS7B;IAAA;QACQ,aAAQ,GAAG,CAAC,CAAC;QACb,SAAI,GAAG,gCAAgC,CAAC;QAEvC,oBAAe,GAA6B,EAAE,CAAC;IAyDxD,CAAC;IArDO,KAAK,CAAC,IAAc;QAC1B,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,KAAK,YAAY,CAAC,CAAC,CAAC;YAClE,kDAAkD;YAClD,yDAAyD;YAEzD,+CAA+C;YAC/C,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;YAC9C,EAAE,CAAC,CAAC,GAAG,KAAK,UAAU,CAAC,CAAC,CAAC;gBACxB,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC;YACxC,CAAC;QACF,CAAC;IACF,CAAC;IAEM,WAAW,CAAC,MAAc;QAChC,wDAAwD;QACxD,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,UAAU;YAClC,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,KAAK,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC;gBAC3C,IAAI,CAAC,cAAc,GAAG,UAAU,CAAC;YAClC,CAAC;YAAC,IAAI,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,KAAK,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC;gBAChD,IAAI,CAAC,mBAAmB,GAAG,UAAU,CAAC;YACvC,CAAC;QACF,CAAC,CAAC,CAAC;QACH,MAAM,CAAC,CACN,IAAI,CAAC,cAAc,KAAK,SAAS;YACjC,IAAI,CAAC,mBAAmB,KAAK,SAAS,CACtC,CAAC;IACH,CAAC;IAEM,OAAO,CAAC,MAAc;QAC5B,4DAA4D;QAC5D,yDAAyD;QACzD,eAAe;QAEf,+BAA+B;QAC/B,IAAI,SAAiC,CAAC;QACtC,EAAE,CAAC,CAAC,IAAI,CAAC,mBAAmB,KAAK,SAAS,CAAC,CAAC,CAAC;YAC5C,SAAS,GAAG,IAAI,CAAC,mBAAmB,CAAC;QACtC,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,cAAc,KAAK,SAAS,CAAC,CAAC,CAAC;YAC9C,SAAS,GAAG,IAAI,CAAC,cAAc,CAAC;QACjC,CAAC;QAAC,IAAI,CAAC,CAAC;YACP,MAAM,IAAI,KAAK,CACd,qEAAqE,CACrE,CAAC;QACH,CAAC;QAED,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC;YACtB;gBACC,IAAI,EAAE,YAAY;gBAClB,IAAI,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,IAAI;gBACvB,QAAQ,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ;aAC/B;SACD,CAAC,CAAC;IACJ,CAAC;CACD;AA7DD,yCA6DC","file":"archDockerfile.js","sourcesContent":["import * as Promise from 'bluebird';\nimport * as _ from 'lodash';\nimport * as path from 'path';\n\nimport { Bundle, FileInfo, Resolver } from '../resolver';\n\n// Internal tuple to pass files and their extensions around\n// the class\n// ArchSpecificDockerfile = [extension, file info]\ntype ArchSpecificDockerfile = [string, FileInfo];\n\nexport default class ArchDockerfileResolver implements Resolver {\n\tpublic priority = 1;\n\tpublic name = 'Archicture-specific Dockerfile';\n\n\tprivate archDockerfiles: ArchSpecificDockerfile[] = [];\n\tprivate satisifiedArch: ArchSpecificDockerfile;\n\tprivate satisfiedDeviceType: ArchSpecificDockerfile;\n\n\tpublic entry(file: FileInfo): void {\n\t\tif (file.name.substr(0, file.name.indexOf('.')) === 'Dockerfile') {\n\t\t\t// If it's a dockerfile with an extension, save it\n\t\t\t// unless it's a Dockerfile.template, in which case don't\n\n\t\t\t// Remove the . from the start of the extension\n\t\t\tconst ext = path.extname(file.name).substr(1);\n\t\t\tif (ext !== 'template') {\n\t\t\t\tthis.archDockerfiles.push([ext, file]);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic isSatisfied(bundle: Bundle): boolean {\n\t\t// Check for both satisfied architecture and device type\n\t\tthis.archDockerfiles.map(dockerfile => {\n\t\t\tif (dockerfile[0] === bundle.architecture) {\n\t\t\t\tthis.satisifiedArch = dockerfile;\n\t\t\t} else if (dockerfile[0] === bundle.deviceType) {\n\t\t\t\tthis.satisfiedDeviceType = dockerfile;\n\t\t\t}\n\t\t});\n\t\treturn (\n\t\t\tthis.satisifiedArch !== undefined ||\n\t\t\tthis.satisfiedDeviceType !== undefined\n\t\t);\n\t}\n\n\tpublic resolve(bundle: Bundle): Promise<FileInfo[]> {\n\t\t// Return the satisfied arch/deviceType specific dockerfile,\n\t\t// as a plain Dockerfile, and the docker daemon will then\n\t\t// execute that\n\n\t\t// device type takes precedence\n\t\tlet satisfied: ArchSpecificDockerfile;\n\t\tif (this.satisfiedDeviceType !== undefined) {\n\t\t\tsatisfied = this.satisfiedDeviceType;\n\t\t} else if (this.satisifiedArch !== undefined) {\n\t\t\tsatisfied = this.satisifiedArch;\n\t\t} else {\n\t\t\tthrow new Error(\n\t\t\t\t'Resolve called without a satisfied architecture specific dockerfile'\n\t\t\t);\n\t\t}\n\n\t\treturn Promise.resolve([\n\t\t\t{\n\t\t\t\tname: 'Dockerfile',\n\t\t\t\tsize: satisfied[1].size,\n\t\t\t\tcontents: satisfied[1].contents\n\t\t\t}\n\t\t]);\n\t}\n}\n"],"sourceRoot":"../src"}